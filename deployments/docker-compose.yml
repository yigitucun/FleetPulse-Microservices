
services:
  keycloak-db:
    image: postgres
    container_name: keycloak-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: root
    ports:
      - "5433:5432"
    networks:
      - fleet_pulse

  alert-service-db:
    image: postgres
    container_name: alert-service-db
    environment:
      POSTGRES_DB: alert
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
    ports:
      - "5434:5432"
    networks:
      - fleet_pulse

  fleet-service-db:
    image: postgres
    container_name: fleet-service-db
    environment:
      POSTGRES_DB: fleet
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
    ports:
      - "5435:5432"
    networks:
      - fleet_pulse

  keycloak:
    image: quay.io/keycloak/keycloak:26.5.2
    container_name: keycloak
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: root
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HTTP_PORT: 9090
    command: start-dev
    ports:
      - "9090:9090"
    depends_on:
      - keycloak-db
    networks:
      - fleet_pulse

  redis:
    image: redis:alpine
    container_name: ingestion-service-redis
    ports:
      - "6379:6379"
    networks:
      - fleet_pulse

  rabbitmq:
    image: rabbitmq:3-management
    container_name: fleetpulse-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fleet_pulse

  discovery-server:
    build: ../services/discovery-server
    container_name: discovery-server
    ports:
      - "8761:8761"
    environment:
      EUREKA_INSTANCE_HOSTNAME: discovery-server
    networks:
      - fleet_pulse

  api-gateway:
      build: ../services/gateway-service
      container_name: gateway-service
      ports:
        - "8060:8060"
      environment:
        EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/
      depends_on:
        - discovery-server
      networks:
        - fleet_pulse
  config-server:
        build: ../services/config-server
        container_name: config-server
        ports:
          - "8888:8888"
        environment:
          SPRING_PROFILES_ACTIVE: native
          SPRING_CLOUD_CONFIG_SERVER_NATIVE_SEARCH_LOCATIONS: file:/app/config
          EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/
        volumes:
          - ../config-repo:/app/config
        depends_on:
          - discovery-server
        networks:
          - fleet_pulse

  fleet-management:
      build: ../services/fleet-management-service
      container_name: fleet-management
      ports:
        - "8083:8083"
      environment:
        SPRING_DATASOURCE_URL: jdbc:postgresql://fleet-service-db:5432/fleet
        EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/
        SPRING_CONFIG_IMPORT: "optional:configserver:http://config-server:8888"
      depends_on:
        - fleet-service-db
        - discovery-server
        - config-server
      networks:
        - fleet_pulse

  alert-service:
      build: ../services/alert-service
      container_name: alert-service
      restart: on-failure
      ports:
        - "8082:8082"
      environment:
        SPRING_DATASOURCE_URL: jdbc:postgresql://alert-service-db:5432/alert
        SPRING_RABBITMQ_HOST: rabbitmq
        EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/
        CONFIG_SERVER_URL: http://config-server:8888
      depends_on:
        rabbitmq:
          condition: service_healthy
        alert-service-db:
          condition: service_started
        discovery-server:
          condition: service_started
        config-server:
          condition: service_started
      networks:
        - fleet_pulse

  ingestion-service:
      build: ../services/ingestion-service
      container_name: ingestion-service
      restart: on-failure
      ports:
        - "8081:8081"
      environment:
        REDIS_URL: redis:6379
        RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
        FLEET_SERVICE_URL: http://fleet-management:8083
        EUREKA_URL: http://discovery-server:8761/eureka
      depends_on:
        rabbitmq:
          condition: service_healthy
        redis:
          condition: service_started
        fleet-management:
          condition: service_started
        discovery-server:
          condition: service_started
      networks:
        - fleet_pulse

networks:
  fleet_pulse: